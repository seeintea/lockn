# W1 产品输出：MVP 范围与数据口径 + 权限模型

> 目标：让后端/前端在 W1 就能对齐“做什么、不做什么、数据怎么算、权限怎么拦”。

---

## 1) MVP 范围与数据口径（收入/支出/转账）

### 1.1 MVP（8 周）范围（用于后续排期不跑偏）

**MVP 必做（1.0）**
- 账号体系：登录/登出（可先不做注册）、会话策略（多端/单端可配置，W1 先做最简单）
- 账本：创建账本、切换账本、账本成员（W1 先支持“自己一个人也能用”）
- 基础配置：分类（收入/支出）、账户（现金/银行卡/信用卡/支付平台）
- 流水：收入/支出/转账录入、列表查询（分页/按时间区间）、编辑/删除
- 首页概览（MVP）：本月收入/支出/结余，账户余额汇总
- 导入/导出（MVP）：至少 1 种 CSV 模板导入 + 去重 + 回滚；导出 CSV
- 权限（MVP）：账本范围 + 接口权限点（见第 2 节）

**明确不做（1.0 先不做）**
- 多币种自动汇率折算（MVP 单币种）
- 复杂投资组合、对账中心、定期交易、通知提醒（后续增强）

### 1.2 W1 交付范围（与你排期里的 W1 目标一致）

**W1 要交付的最小闭环（空数据也可）**
- 能登录
- 能创建账本（或创建并自动选中默认账本）
- 能进入空的“首页/流水页”（后续逐周补齐能力）

**W1 明确不做**
- 流水录入、分类/账户管理（这些在 W2/W3）

### 1.3 核心业务口径（Income / Expense / Transfer）

这里是“统计怎么算、字段怎么填”的统一口径，避免后端算一套、前端展示一套。

#### A. 金额与符号约定（强制统一）
- `amount` 永远为正数（避免同一字段正负混用）
- `type` 决定统计方向：
  - `Expense`：计入支出
  - `Income`：计入收入
  - `Transfer`：不计入收入/支出（只影响账户间余额流动）
  - `Adjustment`（可选，后续）：余额校准，不计入收入/支出（或单独统计）

#### B. 时间口径
- `occurredAt`：交易发生时间（用户选择/导入提供）
- `createdAt`：系统入库时间
- 报表与列表筛选以 `occurredAt` 为准
- 时区：账本配置 `timezone`（默认你自己的时区），后端按账本时区处理“本月/本周”边界

#### C. 分类口径
- `Expense` 必须有支出分类
- `Income` 必须有收入分类
- `Transfer` 不需要分类（若要记录手续费，作为单独一条 `Expense` 更清晰）

#### D. 转账（Transfer）口径（推荐模型）
- 逻辑上是一笔“从 A 账户转出到 B 账户”的业务动作
- 最简落地有两种：
  1) **Transfer 单模型**：字段里包含 `fromAccountId`、`toAccountId`
  2) **双记账模型**：拆成两条流水（支出+收入）并用 `transferId` 关联
     - 优点：账户明细好做
     - 缺点：报表易被算成收入/支出（需要特殊处理）
- 建议：MVP 用 **Transfer 单模型**，后端按账户余额计算时直接处理 from/to 变更

#### E. 退款/冲正（MVP 先给规则，不一定实现）
- 推荐做法：新增一条 `Income`（分类=退款/返现）或 `Adjustment`（视你的偏好）
- 若后续要强关联：用 `relatedTransactionId` 指向原交易

### 1.4 W1 需要对齐的数据字典（最小字段）

W1 只需要支撑“登录 + 建账本 + 进入空页面”，字段先最小化，避免过度设计。

**User（用户）**
- `id`
- `username`/`mobile`/`email`（三选一作为登录标识，先用你现有系统的口径）
- `passwordHash`（后端存）

**Family（家庭，可选）**
- MVP 允许“一个账本=一个家庭”，也可以先不引入 Family 实体
- 如果引入：`id`、`name`、`ownerUserId`

**Book（账本）**
- `id`
- `name`
- `currency`（默认 CNY）
- `timezone`（默认 Asia/Shanghai）
- `ownerUserId`（或通过 member 关系确定）
- `createdAt`

**Member（成员关系，W1 可只做自己）**
- `id`
- `bookId`
- `userId`
- `role`（Owner/Admin/Member/Guest，见权限模型）
- `scope`（W1 可以先固定为“全部”，后续再扩展）

---

## 2) 权限模型：账本范围 + 接口权限点

### 2.1 权限目标（你需要“拦住什么”）
- 数据隔离：不同账本的数据互不可见（最重要）
- 能力控制：谁能建账本、谁能管理成员、谁能删数据、谁能导出

### 2.2 权限设计（RBAC + Scope）

**两层校验（每个请求都要同时满足）**
1) **接口权限点（Permission Code）**：你有没有“做这件事”的资格
2) **资源范围（Scope）**：你能不能“对这个账本/资源”做这件事

例：`transaction:delete` 需要你有删除权限，同时该 transaction 属于你有权访问的 book。

### 2.3 角色定义（默认 4 角色）
- `Owner`：账本所有者，拥有全部权限（含删除账本/导出/成员管理）
- `Admin`：配置管理（分类/账户/预算/导入导出），通常不允许删账本
- `Member`：记账与查看（默认允许新增/编辑自己的流水，是否能编辑他人由 scope 决定）
- `Guest`（可选）：只读（看列表/报表）

### 2.4 资源范围（Scope）维度（W1 先做账本级）

**W1（最小可用）**
- scope 只做：`bookId` 级别隔离（必须是该账本成员）

**后续增强（W7 才需要）**
- 可见范围扩展为：
  - `all`：可见账本全部数据
  - `self`：仅可见 `ownerUserId == me` 的流水
  - `accounts:[...]`：仅可见指定账户
  - `categories:[...]`：仅可见指定分类

### 2.5 接口权限点命名规范（建议）
- 统一前缀：`book:*`、`member:*`、`account:*`、`category:*`、`transaction:*`、`report:*`、`import:*`、`export:*`、`audit:*`
- 动作：`create/read/update/delete/manage/invite/approve`

### 2.6 W1 必需的权限点清单（最小集）

W1 只要覆盖登录后“建账本/切账本/进入页面所需的数据读取”。

- `book:create`：创建账本
- `book:read`：读取账本信息/列表
- `book:switch`：切换当前账本（也可不用单独权限点，等同 read）
- `member:read`：读取成员列表（W1 可选）
- `member:invite`：邀请成员（W1 可先不上线，但权限点先预留）

**建议默认授权**
- Owner：全部
- Admin：`book:read`、`member:*`（可按你偏好缩小）、以及后续配置类权限
- Member：`book:read`
- Guest：`book:read`（只读）

### 2.7 权限校验规则（落地时一条条可编码）
- 所有业务接口（除登录）必须携带 `bookId`（路径、query 或 header，选一种固定下来）
- 后端先校验：`isMember(bookId, userId)`，不是成员直接拒绝
- 再校验：`hasPermission(userId, bookId, permissionCode)`
- 数据查询必须额外加 `bookId` 条件（避免越权的根源）

### 2.8 W1 决策结论（便于你立刻开工）
- W1 权限范围只做“账本级隔离 + 角色权限点”，不做账户/分类粒度
- W1 只需要最小权限点：`book:create`、`book:read`（其余预留）
- 后续扩展 scope 不影响当前模型（scope 字段可空/默认 all）

